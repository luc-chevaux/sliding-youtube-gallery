<?php
// include zend loader
$root = realpath(dirname(dirname(dirname(dirname(dirname(dirname(dirname(dirname($_SERVER["SCRIPT_FILENAME"])))))))));

if (file_exists($root.'/wp-load.php')) {
	// WP 2.6
	require_once($root.'/wp-load.php');
} else {
	// Before 2.6
	require_once($root.'/wp-config.php');
}

// include required wordpress object
require_once( ABSPATH . 'wp-admin/includes/plugin.php' );
require_once( ABSPATH . 'wp-content/plugins/sliding-youtube-gallery/engine/SygPlugin.php');
require_once( ABSPATH . 'wp-content/plugins/sliding-youtube-gallery/engine/SygUtil.php');
require_once( ABSPATH . 'wp-content/plugins/sliding-youtube-gallery/engine/SygConstant.php');

$syg = SygPlugin::getInstance();
$option = $syg->getGallerySettings($_GET['id']);
extract ($option);

$target_dir = WP_PLUGIN_DIR . SygConstant::WP_PLUGIN_PATH . SygConstant::WP_CACHE_JS_REL_DIR. $id . DIRECTORY_SEPARATOR;

if (!file_exists($target_dir)) {
	mkdir($target_dir); 
	chmod(realpath($target_dir), 0777);
}

$writabledir = $target_dir;

header('Content-type: text/javascript; charset=utf-8');
header('Expires: '.gmdate("D, d M Y H:i:s", time() + 3600*24*365).' GMT');

$uiType = $_GET['ui'];
$cache = $_GET['cache'];

$name = 'client.' . $uiType . '.' . $cache . '-' . SygUtil::folder2Md5('./');

if(file_exists($writabledir.$name)) {
	readfile($writabledir.$name);
} else {
	$url = WP_PLUGIN_URL . SygConstant::WP_JS_PATH . 'core/ui/ready/syg.client.js.php?id='.$id;	
	if (!empty($cache)) $url .= '&cache='.$cache;
	if (!empty($uiType)) $url .= '&ui='.$uiType;
	
	$js .= file_get_contents($url);
	
	if(isset($_REQUEST['minify'])) {
		require_once (ABSPATH . 'wp-content/plugins/sliding-youtube-gallery/engine/lib/jsmin-php/jsmin.php');		
		$js = JSMin::minify($js);
		file_put_contents($writabledir.$name,$js);
		SygUtil::cleanJsCache($writabledir);
		exit;
	} else {
		$js.="setTimeout(function(){var a=document.createElement('img');a.src='syg.client.min.js.php?minify=1&id=".$id."&ui=".$uiType."&cache=".$cache."';a.style.display='none';document.body.appendChild(a);},5000);";
	}
	echo $js;
}
?>